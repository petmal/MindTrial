<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{.VersionData.Name}} - Run Results</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --background-color: #f7f7f7;
            --text-color: #333;
            --header-color: #444;
            --table-bg: #fff;
            --table-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --row-hover-bg: #f1f9ff;
            --row-even-bg: #f2f2f2;
            --row-odd-bg: #ffffff;
            --success-bg: #d4edda;
            --success-text: #155724;
            --failure-bg: #fff3cd;
            --failure-text: #856404;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --skipped-bg: #e2e3e5;
            --skipped-text: #383d41;
            --border-color: #e0e0e0;
            /* Matrix dimension controls (box-sized) */
            --matrix-header-size: 120px; /* Row header width & column header height */
            --matrix-header-fudge: 4px;  /* Tiny adjustment to counter collapse/rounding */
            --matrix-cell-size: 60px;   /* Square cell size */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 1em;
        }
        h1, h2 {
            text-align: center;
            color: var(--header-color);
        }
        h1 { margin-bottom: 0.2em; }
        h2 { margin-top: 1.5em; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2em;
            box-shadow: var(--table-shadow);
            background-color: var(--table-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }
        thead th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            position: relative;
        }
    
    /* Scope zebra striping and hover to non-matrix tables to avoid interference */
    table:not(.matrix-table) tbody tr:nth-child(even) { background-color: var(--row-even-bg); }
    table:not(.matrix-table) tbody tr:nth-child(odd) { background-color: var(--row-odd-bg); }
    table:not(.matrix-table) tbody tr:hover { background-color: var(--row-hover-bg); }
        .status-passed { background-color: var(--success-bg); color: var(--success-text); font-weight: bold; }
        .status-failed { background-color: var(--failure-bg); color: var(--failure-text); font-weight: bold; }
        .status-error { background-color: var(--error-bg); color: var(--error-text); font-weight: bold; }
        .status-skipped { background-color: var(--skipped-bg); color: var(--skipped-text); font-weight: bold; }
    .details { cursor: pointer; color: var(--primary-color); font-weight: 600; text-decoration: underline; background: none; border: none; padding: 0; font-size: 0.95em; }
        .details:focus { outline: 2px solid var(--primary-color); }
    .details-content { display: none; background-color: #fafafa; border: 1px solid var(--border-color); margin-top: 8px; padding: 14px 16px; font-size: 0.95em; border-radius:6px; max-width:900px; }
    .details-content section { margin-top: 1.1em; }
    .details-content section:first-of-type { margin-top: 0; }
    .details-content h4 { margin: 0 0 0.35em 0; color: var(--header-color); font-size: 1.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
    /* Prevent wrapping of section titles & summary labels */
    .details-content summary { white-space: nowrap; cursor: pointer; }
    .details-content details { margin: 0.4em 0; }
     /* Caret system:
         - All details: hide native marker; inject uniform caret (‚ñ∂/‚ñº) at left inside content flow.
         - Explanation blocks: create hanging caret (outdented) so summary + paragraphs align vertically with each other (caret sits in margin).
         - Other blocks (Actual Answer, Expected, Technical): caret sits in reserved space; content (code blocks, lists, dl) lines up under summary text, not under caret.
     */
     .details-content details summary { list-style:none; cursor:pointer; position:relative; padding-left:1.1em; }
     .details-content details summary::-webkit-details-marker { display:none; }
    .details-content details summary:before { content:'‚ñ∂'; position:absolute; left:0; top:0.12em; font-size:0.92em; line-height:1; }
     .details-content details[open] summary:before { content:'‚ñº'; }
     /* Explanation variant: hanging caret */
     .details-content details.explanation { padding-left:1.1em; }
     .details-content details.explanation summary { padding-left:0; }
     .details-content details.explanation summary:before { left:-1.1em; }
     .details-content details.explanation .explanation-body { margin-left:0; }
    /* Bold numbering for expected acceptable answers to mirror error detail keys, slightly smaller */
    .details-content ol.expected-answers { margin-left:1.2em; }
    .details-content ol.expected-answers li::marker { font-weight:700; font-size:0.8em; color:#555; }
    .section-answer { border-left: 4px solid var(--primary-color); padding-left: 10px; }
    .section-validation { border-left: 4px solid #28a745; padding-left: 10px; }
    .section-error { border-left: 4px solid #c0392b; padding-left: 10px; background: #fff6f6; }
    .section-error h4 { color: #a1271c; }
    .details-content pre { background:#fff; border:1px solid var(--border-color); padding:6px 8px; overflow:auto; border-radius:4px; max-height:300px; white-space:pre-wrap; word-break:break-word; }
    .details-content code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 0.85em; }
    .details-content dl { margin:0.5em 0 0 0; }
    .details-content dt { font-weight:600; margin-top:0.6em; font-size:0.85em; }
     .details-content dd { margin:0.2em 0 0.6em 0.8em; font-size:0.85em; }
     /* Technical details alignment: mimic expected answers indentation model
         - Reserve 1.2em gutter for keys (like list markers)
         - Keys (dt) sit in gutter via negative margin; values (dd) align with paragraph/text start */
     .details-content dl.tech-details { padding-left:1.2em; }
     .details-content dl.tech-details dt { margin-left:-1.2em; }
     .details-content dl.tech-details dd { margin:0.2em 0 0.6em 0; }
    /* Details column: keep button on a single line & provide stable minimum width */
    td.details-toggle-cell { min-width:130px; vertical-align: top; text-align:right; }
    td.details-toggle-cell .details { white-space:nowrap; }
    td.details-toggle-cell .details-content { margin-top:8px; text-align:left; }
    .details-icons { display: flex; gap: 8px; margin-top: 8px; align-items: center; justify-content: flex-end; }
    .icon-btn { cursor: pointer; background: none; border: none; padding: 4px; font-size: 1.1em; opacity: 0.6; transition: opacity 0.2s; }
    .icon-btn:hover { opacity: 1; }
    .icon-btn:focus { outline: 2px solid var(--primary-color); border-radius: 2px; }
    .answer-list { margin: 0; padding-left: 1.5em; }
        .answer-list li { margin-bottom: 1em; }
        .answer-list.single { list-style-type: none; padding-left: 0; }
        .answer-list.single li { margin-bottom: 0; }
        .details-cell pre { font-family: inherit; margin: 0; line-height: inherit; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; overflow-x: auto; }
        .filter-container { display: flex; gap: 10px; margin-bottom: 10px; max-width: 800px; align-items: center; }
        .filter-sort-controls { display: flex; flex-direction: column; gap: 5px; }
        .filter-sort-controls .header-with-sort { display: flex; align-items: center; gap: 5px; }
        .filter-sort-controls input, .filter-sort-controls select { width: 100%; box-sizing: border-box; }
        .sort-btn { cursor: pointer; margin-left: 5px; }
        .clickable { cursor: pointer; }
    footer { text-align: center; font-size: 0.85em; color: #777; margin-top: 2em; border-top: 1px solid var(--border-color); padding-top: 1em; }
    .para { margin:0 0 0.7em 0; }
    .para:last-child { margin-bottom:0; }
    .visually-hidden { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0; }
    th.details-header { text-align:right; min-width:130px; }
    
    /* Comparison matrix styles */
    .matrix-container { 
        padding: 20px; /* Increased padding to prevent edge overflow */
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        display: flex;
        flex-direction: column;
        align-items: center;
        width: calc(100% - 40px); /* Account for padding */
        max-width: max-content;
        margin: 0 auto;
        box-sizing: border-box;
    }
    .matrix-table { 
        border-collapse: collapse; 
        border-spacing: 0; 
        margin: 10px auto; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        width: auto; /* Allow natural sizing */
        max-width: max-content; /* Don't grow beyond content needs */
        table-layout: fixed; /* Prevent table from stretching unnecessarily */
    }
    .matrix-table th, .matrix-table td { border: 1px solid #ddd; text-align: center; vertical-align: middle; box-sizing: border-box; }
    .matrix-table th { 
        background-color: var(--primary-color); 
        color: white; 
        font-weight: 600; 
        padding: 4px 2px; 
        font-size: 0.7em;
        text-transform: none;
        line-height: 1.1;
    }
    .matrix-table .matrix-header { 
        writing-mode: vertical-lr; 
        text-orientation: mixed; 
        min-width: 30px; 
        max-width: 40px; /* Limit horizontal growth */
    width: 30px;
    height: calc(var(--matrix-header-size) + var(--matrix-header-fudge));
    max-height: 200px; /* Reasonable limit on height growth */
        white-space: normal; 
        overflow: hidden; 
        overflow-wrap: break-word;
        word-break: break-word;
        padding: 4px 1px; 
        font-size: 0.65em;
        font-weight: 600;
        line-height: 1.0;
        text-transform: none;
    box-sizing: border-box; /* include padding/border in height */
    }
    .matrix-table .matrix-row-header { 
        background-color: var(--primary-color); 
        color: white; 
        font-weight: 600; 
    padding: 4px 1px; 
        text-align: center; 
    width: var(--matrix-header-size);
    max-width: 200px; /* Limit horizontal growth for row headers */
        white-space: normal; 
        overflow: hidden; 
        font-size: 0.65em;
        line-height: 1.0;
        word-break: break-all;
        text-transform: none;
    box-sizing: border-box; /* include padding/border in width */
    }
    .matrix-cell { 
    width: var(--matrix-cell-size); 
    height: var(--matrix-cell-size); 
        padding: 2px; 
        position: relative; 
        cursor: default;
        transition: background-color 0.2s ease;
    box-sizing: border-box;
    }
    .matrix-cell.diagonal { font-weight: bold; }
    .matrix-cell-content { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; font-size: 0.8em; }
    .matrix-percentage { font-weight: bold; margin-bottom: 1px; font-size: 0.9em; }
    .matrix-details { font-size: 0.7em; opacity: 0.9; }
    .matrix-legend { 
        margin: 10px 0; 
        padding: 8px 12px; 
        background-color: #f8f9fa; 
        border-radius: 4px; 
        font-size: 0.85em;
        width: 100%; /* Take full available width */
        box-sizing: border-box; /* Include padding in width calculation */
    }
    .matrix-legend h3 { margin: 0 0 8px 0; color: var(--header-color); font-size: 1em; }
    .matrix-legend-items { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        margin-bottom: 5px; 
        justify-content: flex-start; /* Align items to the left */
    }
    .matrix-legend-item { display: flex; align-items: center; }
    .matrix-legend-color { display: inline-block; width: 16px; height: 12px; margin-right: 5px; border: 1px solid #ccc; }
    .matrix-legend p { margin: 5px 0 0 0; font-size: 0.8em; color: #666; }
    /* Match spacing to filters/results distance */
    #summary-table { margin-bottom: 10px; }
    
    #compare-selected-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .matrix-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    .matrix-modal-content {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        max-height: 70vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        margin: 20px;
    }
    .matrix-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
    }
    .matrix-modal-title {
        margin: 0;
        font-size: 1.1em;
        color: var(--header-color);
    }
    .matrix-modal-close {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }
    .matrix-modal-close:hover {
        background: #f5f5f5;
        color: #333;
    }
    .matrix-modal-summary {
        margin: 0 0 16px 0;
        font-size: 0.95em;
        color: #666;
    }
    .matrix-modal .status-group {
        margin-bottom: 16px;
    }
    .matrix-modal .status-group:last-child {
        margin-bottom: 0;
    }
    .matrix-modal .status-title {
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: capitalize;
        font-size: 1em;
    }
    .matrix-modal .status-title.passed { color: var(--success-text); }
    .matrix-modal .status-title.failed { color: var(--failure-text); }
    .matrix-modal .status-title.error { color: var(--error-text); }
    .matrix-modal .task-list {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 8px 12px;
        margin: 0;
        font-size: 0.9em;
        max-height: 200px;
        overflow-y: auto;
    }
    .matrix-modal .task-item {
        margin-bottom: 4px;
        padding: 2px 0;
        word-break: break-word;
        user-select: text;
        cursor: text;
    }
    .matrix-modal .task-item:last-child {
        margin-bottom: 0;
    }
    .empty-task-message {
        color: #666;
        font-style: italic;
    }
    .selected-count {
        margin-left: 10px;
        font-size: 0.9em;
        color: #666;
    }
    </style>
    <script>
        function toggleDetails(id, btn) {
            const element = document.getElementById(id);
            const show = (element.style.display === "none" || element.style.display === "");
            element.style.display = show ? "block" : "none";
            if (btn) {
                btn.setAttribute('aria-expanded', show ? 'true' : 'false');
                btn.textContent = show ? 'Hide Details' : 'Show Details';
            }
        }

        function copyTraceID(traceID, btn) {
            navigator.clipboard.writeText(traceID).then(() => {
                const originalTitle = btn.title;
                btn.title = 'Copied!';
                setTimeout(() => { btn.title = originalTitle; }, 2000);
            }).catch(() => {
                btn.title = 'Failed to copy';
            });
        }

        function updateVisibleCount(table) {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const visible = rows.filter(r => r.style.display !== 'none').length;
            const counter = document.getElementById('visible-count');
            if (counter) counter.textContent = visible;
        }

        function filterAndSortTable() {
            const table = document.getElementById('results-table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const filters = {
                provider: document.getElementById('provider-filter').value.toLowerCase(),
                run: document.getElementById('run-filter').value.toLowerCase(),
                task: document.getElementById('task-filter').value,
                status: document.getElementById('status-filter').value.toLowerCase(),
                search: document.getElementById('search-filter').value
            };
            let taskRegex = null, searchRegex = null;
            if (filters.task) {
                try { taskRegex = new RegExp(filters.task, 'i'); } catch (e) { taskRegex = null; }
            }
            if (filters.search) {
                try { searchRegex = new RegExp(filters.search, 'i'); } catch (e) { searchRegex = null; }
            }
            rows.forEach(row => {
                const provider = row.dataset.provider.toLowerCase();
                const run = row.dataset.run.toLowerCase();
                const task = row.dataset.task;
                const status = row.dataset.status.toLowerCase();

                const searchMatch = searchRegex ? (searchRegex.test(provider) || searchRegex.test(run) || searchRegex.test(task)) : (!filters.search || provider.includes(filters.search.toLowerCase()) || run.includes(filters.search.toLowerCase()) || task.toLowerCase().includes(filters.search.toLowerCase()));

                const show = (filters.provider === '' || provider === filters.provider) &&
                             (filters.run === '' || run === filters.run) &&
                             (!taskRegex || taskRegex.test(task)) &&
                             (filters.status === '' || status === filters.status) &&
                             (filters.search === '' || searchMatch);
                
                row.style.display = show ? '' : 'none';
            });
            updateVisibleCount(table);
        }

        function sortTable(tableId, column, direction) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let valA, valB;
                if (column.startsWith('duration') || column.startsWith('passed') || column.startsWith('failed') || column.startsWith('error') || column.startsWith('skipped') || column.startsWith('passrate') || column.startsWith('accuracy') || column.startsWith('errorrate')) {
                    valA = parseFloat(a.dataset[column]);
                    valB = parseFloat(b.dataset[column]);
                } else {
                    valA = a.dataset[column].toLowerCase();
                    valB = b.dataset[column].toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function setupSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tableId = button.closest('table').id;
                    const column = button.dataset.column;
                    const direction = button.dataset.direction || 'asc';
                    
                    document.querySelectorAll(`#${tableId} .sort-btn`).forEach(btn => {
                        if (btn !== button) {
                            btn.innerHTML = '‚ÜïÔ∏è';
                            delete btn.dataset.direction;
                        }
                    });

                    sortTable(tableId, column, direction);
                    button.innerHTML = direction === 'asc' ? 'üîº' : 'üîΩ';
                    button.dataset.direction = direction === 'asc' ? 'desc' : 'asc';
                });
            });
        }
        
        function setupClickableFilters() {
            document.querySelectorAll('.clickable-filter').forEach(element => {
                element.addEventListener('click', () => {
                    const filterType = element.dataset.filterType;
                    const filterValue = element.dataset.filterValue;
                    document.getElementById(`${filterType}-filter`).value = filterValue;
                    filterAndSortTable();
                });
            });
        }

        function clearFilters() {
            document.getElementById('provider-filter').value = '';
            document.getElementById('run-filter').value = '';
            document.getElementById('task-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('search-filter').value = '';
            filterAndSortTable();
        }

        function updateCompareButton() {
            const checkboxes = document.querySelectorAll('.run-compare-checkbox:checked');
            const button = document.getElementById('compare-selected-btn');
            const counter = document.getElementById('selected-count');
            
            button.disabled = checkboxes.length < 2;
            counter.textContent = checkboxes.length > 0 ? `${checkboxes.length} selected` : '';
        }

        function compareSelectedRuns() {
            const checkboxes = document.querySelectorAll('.run-compare-checkbox:checked');
            if (checkboxes.length < 2) return;

            const selectedRuns = Array.from(checkboxes).map(cb => ({
                provider: cb.dataset.provider,
                run: cb.dataset.run,
                key: `${cb.dataset.provider}-${cb.dataset.run}`
            }));

            const matrix = generateComparisonMatrix(selectedRuns);
            openMatrixWindow(matrix, selectedRuns);
        }

    function generateComparisonMatrix(runs) {
            const matrix = {};
            const results = getResultsData();

            for (let i = 0; i < runs.length; i++) {
                for (let j = 0; j < runs.length; j++) {
                    const runA = runs[i];
                    const runB = runs[j];
                    const key = `${runA.key}-${runB.key}`;
                    
                    if (i === j) {
                        // For diagonal, calculate the run's own breakdown
                        const data = results[runA.key] || {};
                        const tasks = Object.keys(data).filter(task => data[task] !== 'skipped');
                        const tasksByStatus = {};
                        tasks.forEach(task => {
                            const status = data[task];
                            if (!tasksByStatus[status]) tasksByStatus[status] = [];
                            tasksByStatus[status].push(task);
                        });
                        matrix[key] = {
                            agree: {
                                percentage: 100,
                                identical: true,
                                tasksByStatus,
                                total: tasks.length,
                                common: tasks.length
                            },
                            disagree: {
                                percentage: 0,
                                identical: false,
                                tasksByStatus: {},
                                total: tasks.length,
                                common: 0
                            }
                        };
                    } else {
                        matrix[key] = calculateAgreementDisagreement(runA, runB, results);
                    }
                }
            }

            return matrix;
        }

        function getResultsData() {
            const results = {};
            const rows = document.querySelectorAll('#results-table tbody tr');
            
            rows.forEach(row => {
                const provider = row.dataset.provider;
                const run = row.dataset.run;
                const task = row.dataset.task;
                const status = row.dataset.status;
                
                const key = `${provider}-${run}`;
                if (!results[key]) results[key] = {};
                results[key][task] = status;
            });
            
            return results;
        }

        

        function calculateAgreementDisagreement(runA, runB, results) {
            const dataA = results[runA.key] || {};
            const dataB = results[runB.key] || {};

            const commonTasks = Object.keys(dataA).filter(task => task in dataB);
            const nonSkippedTasks = commonTasks.filter(task => 
                dataA[task] !== 'skipped' && dataB[task] !== 'skipped'
            );

            if (nonSkippedTasks.length === 0) {
                return {
                    agree: { percentage: 0, total: 0, common: 0, tasksByStatus: {} },
                    disagree: { percentage: 0, total: 0, common: 0, tasksByStatus: {} }
                };
            }

            const agreeByStatus = {};
            const disagreeList = [];
            let agreeCount = 0;

            nonSkippedTasks.forEach(task => {
                const a = dataA[task];
                const b = dataB[task];
                if (a === b) {
                    if (!agreeByStatus[a]) agreeByStatus[a] = [];
                    agreeByStatus[a].push(task);
                    agreeCount += 1;
                } else {
                    disagreeList.push(task);
                }
            });

            const total = nonSkippedTasks.length;
            const agreePct = Math.round((agreeCount / total) * 100);
            const disagreeCount = total - agreeCount;
            const disagreePct = 100 - agreePct;

            return {
                agree: { percentage: agreePct, total, common: agreeCount, tasksByStatus: agreeByStatus },
                disagree: { percentage: disagreePct, total, common: disagreeCount, tasksByStatus: { tasks: disagreeList } }
            };
        }

        function generateMatrixColor(overlap) {
            if (overlap.percentage === 0) return 'transparent';
            
            const saturation = overlap.percentage / 100;
            const total = overlap.common;
            
            if (total === 0) return 'transparent';
            
            const passed = overlap.tasksByStatus.passed ? overlap.tasksByStatus.passed.length : 0;
            const failed = overlap.tasksByStatus.failed ? overlap.tasksByStatus.failed.length : 0;
            const error = overlap.tasksByStatus.error ? overlap.tasksByStatus.error.length : 0;
            
            const passedRatio = passed / total;
            const failedRatio = failed / total;
            const errorRatio = error / total;
            
            const r = Math.round(155 * passedRatio + 255 * failedRatio + 255 * errorRatio);
            const g = Math.round(255 * passedRatio + 255 * failedRatio + 100 * errorRatio);
            const b = Math.round(155 * passedRatio + 100 * failedRatio + 100 * errorRatio);
            
            return `rgba(${r}, ${g}, ${b}, ${saturation})`;
        }

        function generateDisagreementColor(dis) {
            if (dis.percentage === 0) return 'transparent';
            const saturation = dis.percentage / 100;
            // Lighter gray-blue for improved black text readability
            const r = 176, g = 186, b = 196;
            return `rgba(${r}, ${g}, ${b}, ${saturation})`;
        }

        function openMatrixWindow(matrix, runs) {
            const html = generateMatrixHTML(matrix, runs);
            // Calculate window size based on matrix dimensions with updated header sizes
            const cellWidth = 60;      // Matrix cells are 60px wide (square)
            const headerWidth = 120;   // Row headers are 120px wide (increased)
            const padding = 80;
            const titleHeight = 60;    // Reduced: Less space needed for title
            const legendHeight = 120;  // Increased: More space for legend
            const headerRowHeight = 120; // Column headers are ~120px tall (equalized to row header width)
            const containerPadding = 30; // Matrix container padding
            const tableMargins = 40;   // Reduced: Less margin needed
            const extraBuffer = 60;    // Increased: More bottom space for small matrices
            const minWidth = 600; // Increased to better accommodate legend
            const minHeight = 500;     // Increased minimum height for small matrices
            
            // More accurate calculations with updated dimensions
            const tableWidth = headerWidth + (runs.length * cellWidth) + padding + 50;
            const legendMinWidth = 450; // Increased minimum width needed for legend
            const calculatedWidth = Math.max(tableWidth, legendMinWidth);
            const matrixRowsHeight = Math.max(runs.length * 60, 180); // Ensure minimum matrix content height
            const tableHeight = titleHeight + legendHeight + headerRowHeight + containerPadding + 
                              tableMargins + matrixRowsHeight + extraBuffer;
            
            const width = Math.max(minWidth, Math.min(1400, calculatedWidth));
            const height = Math.max(minHeight, Math.min(1000, tableHeight));
            
            const newWindow = window.open('', '_blank', `width=${width},height=${height},scrollbars=yes,resizable=yes`);
            newWindow.document.write(html);
            newWindow.document.close();
        }

        function generateMatrixHTML(matrix, runs) {
            // Escape potentially unsafe characters before injecting into HTML
            function escapeHtml(s) {
                return String(s).replace(/[&<>"']/g, c => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[c] || c);
            }
            let html = `
<!DOCTYPE html>
<html>
<head>
    <title>Run Comparison Matrix</title>
    <style>
        ${document.querySelector('style').textContent}
    </style>
    <script>
        function setupMatrixHover() {
            const table = document.querySelector('.matrix-table');
            const cells = table.querySelectorAll('.matrix-cell');
            
            cells.forEach((cell, index) => {
                const row = Math.floor(index / ${runs.length});
                const col = index % ${runs.length};
                
                cell.addEventListener('mouseenter', () => {
                    // Highlight row
                    const rowCells = table.querySelectorAll(\`tbody tr:nth-child(\${row + 1}) .matrix-cell\`);
                    rowCells.forEach(c => c.classList.add('row-highlight'));
                    
                    // Highlight column
                    const colCells = table.querySelectorAll(\`tbody tr .matrix-cell:nth-child(\${col + 2})\`);
                    colCells.forEach(c => c.classList.add('col-highlight'));
                });
                
                cell.addEventListener('mouseleave', () => {
                    // Remove all highlights
                    cells.forEach(c => {
                        c.classList.remove('row-highlight', 'col-highlight');
                    });
                });
            });
        }
        
        function setupMatrixModal() {
            // Create modal element
            const modal = document.createElement('div');
            modal.className = 'matrix-modal';
            modal.innerHTML = \`
                <div class="matrix-modal-content">
                    <div class="matrix-modal-header">
                        <h3 class="matrix-modal-title"></h3>
                        <button class="matrix-modal-close" title="Close">&times;</button>
                    </div>
                    <p class="matrix-modal-summary"></p>
                    <div class="matrix-modal-body"></div>
                </div>
            \`;
            document.body.appendChild(modal);
            
            const modalContent = modal.querySelector('.matrix-modal-content');
            const title = modal.querySelector('.matrix-modal-title');
            const summary = modal.querySelector('.matrix-modal-summary');
            const body = modal.querySelector('.matrix-modal-body');
            const closeBtn = modal.querySelector('.matrix-modal-close');
            
            // Close modal handlers
            const closeModal = () => {
                modal.style.display = 'none';
            };
            
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    closeModal();
                }
            });
            
            // Add click handlers to matrix cells
            document.querySelectorAll('.matrix-cell[data-modal]').forEach(cell => {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', (e) => {
                    const data = JSON.parse(e.currentTarget.getAttribute('data-modal'));
                    
                    title.textContent = data.title;
                    summary.textContent = data.summary;
                    
                    body.innerHTML = generateModalContent(data.tasksByStatus);
                    
                    modal.style.display = 'flex';
                });
            });
        }
        
        function generateModalContent(tasksByStatus) {
            if (Object.keys(tasksByStatus).length === 0) {
                return '<p class="empty-task-message">No tasks to display</p>';
            }
            
            let content = '';
            const keys = Object.keys(tasksByStatus);
            const defaultOrder = ['passed', 'failed', 'error'];
            const isDefault = keys.every(k => defaultOrder.includes(k));
            const order = keys.length === 1 && keys[0] === 'tasks'
                ? ['tasks']
                : (isDefault ? defaultOrder.filter(k => keys.includes(k)) : keys.sort());
            
            order.forEach(status => {
                const items = tasksByStatus[status];
                if (items && items.length > 0) {
                    const title = status === 'tasks' ? 'Tasks' : (status.charAt(0).toUpperCase() + status.slice(1));
                    content += \`
                        <div class="status-group">
                            <div class="status-title \${status}">\${title} (\${items.length}):</div>
                            <div class="task-list">\`;
                    items.forEach(task => {
                        content += \`<div class="task-item">\${task}</div>\`;
                    });
                    content += \`</div></div>\`;
                }
            });
            
            return content;
        }
        
        function equalizeMatrixHeaderSizes() {
            const rowHeaders = Array.from(document.querySelectorAll('.matrix-row-header'));
            if (rowHeaders.length === 0) return;
            
            // Calculate target width but apply reasonable limits
            const currentWidths = rowHeaders.map(h => h.getBoundingClientRect().width);
            const maxCurrentWidth = Math.max(...currentWidths);
            
            // Limit growth: don't exceed 200px or grow more than 50% beyond original
            const originalWidth = 120; // var(--matrix-header-size)
            const maxAllowedWidth = Math.min(200, originalWidth * 1.5);
            const targetWidth = Math.min(maxCurrentWidth, maxAllowedWidth);
            
            // Only adjust column header height if it makes sense (avoid excessive growth)
            const targetHeight = Math.min(targetWidth + 4, 200); // +4 for fudge, max 200px
            
            document.querySelectorAll('.matrix-header').forEach(h => {
                h.style.height = targetHeight + 'px';
                // Don't change width - keep column headers narrow
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupMatrixHover();
            setupMatrixModal();
            equalizeMatrixHeaderSizes();
        });
        window.addEventListener('resize', equalizeMatrixHeaderSizes);
    </script>
    <style>
        .matrix-cell.row-highlight {
            box-shadow: inset 0 0 0 2px rgba(74, 144, 226, 0.4) !important;
        }
        .matrix-cell.col-highlight {
            box-shadow: inset 0 0 0 2px rgba(74, 144, 226, 0.4) !important;
        }
        .matrix-cell.row-highlight.col-highlight {
            box-shadow: inset 0 0 0 3px rgba(74, 144, 226, 0.6) !important;
        }
    </style>
</head>
<body>
    <div class="matrix-container">
        <h1>Run Comparison Matrix</h1>
        <div class="matrix-legend">
            <h3>Legend</h3>
            <div class="matrix-legend-items">
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(155, 255, 155, 0.8);"></span>
                    <span>Passed</span>
                </div>
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(255, 255, 100, 0.8);"></span>
                    <span>Failed</span>
                </div>
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(255, 100, 100, 0.8);"></span>
                    <span>Error</span>
                </div>
            </div>
            <div class="matrix-legend-items">
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(176, 186, 196, 0.8);"></span>
                    <span>Disagreement</span>
                </div>
            </div>
            <p>Color saturation = overlap %, Color hue = distribution of overlapping results</p>
            <p>Disagreement saturation = disagreement %</p>
            <p>The matrix is symmetrical. Lower triangle shows overlap; upper triangle shows disagreement. Diagonal shows per-run distribution.</p>
        </div>
        <table class="matrix-table">
            <thead>
                <tr>
                    <th></th>`;
            
            runs.forEach(run => {
                html += `<th class="matrix-header" title="${escapeHtml(run.provider)} - ${escapeHtml(run.run)}">${escapeHtml(run.run)}</th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            runs.forEach((runA, i) => {
                html += `<tr><th class="matrix-row-header" title="${escapeHtml(runA.provider)} - ${escapeHtml(runA.run)}">${escapeHtml(runA.run)}</th>`;
                
                runs.forEach((runB, j) => {
                    const key = `${runA.key}-${runB.key}`;
                    if (i === j) {
                        const diag = matrix[key].agree;
                        const p = diag.tasksByStatus.passed ? diag.tasksByStatus.passed.length : 0;
                        const f = diag.tasksByStatus.failed ? diag.tasksByStatus.failed.length : 0;
                        const e = diag.tasksByStatus.error ? diag.tasksByStatus.error.length : 0;
                        const tooltipText = `Run distribution: Passed ${p}, Failed ${f}, Error ${e}`;
                        const modalData = { title: `${escapeHtml(runA.run)}`, summary: `${diag.total} tasks total`, tasksByStatus: diag.tasksByStatus };
                        const color = generateMatrixColor(diag);
                        html += `<td class="matrix-cell diagonal" style="background-color: ${color};" title="${tooltipText}" data-modal='${JSON.stringify(modalData).replace(/'/g, "&#39;")}'>
                            <div class="matrix-cell-content">
                                <div class="matrix-percentage">${diag.percentage}%</div>
                                <div class="matrix-details">${diag.total} tasks</div>
                            </div>
                        </td>`;
                        return;
                    }
                    if (j < i) {
                        const overlap = matrix[key].agree;
                        const color = generateMatrixColor(overlap);
                        const p = overlap.tasksByStatus.passed ? overlap.tasksByStatus.passed.length : 0;
                        const f = overlap.tasksByStatus.failed ? overlap.tasksByStatus.failed.length : 0;
                        const e = overlap.tasksByStatus.error ? overlap.tasksByStatus.error.length : 0;
                        let tooltipText, modalData;
                        if (!overlap.total) {
                            tooltipText = 'No comparable tasks (all skipped or none in common)';
                            modalData = { title: `${escapeHtml(runA.run)} = ${escapeHtml(runB.run)}`, summary: 'All tasks were skipped or none in common', tasksByStatus: {} };
                        } else {
                            tooltipText = `Overlap: ${overlap.percentage}% (${overlap.common}/${overlap.total}) | Passed ${p}, Failed ${f}, Error ${e}`;
                            modalData = { title: `${escapeHtml(runA.run)} = ${escapeHtml(runB.run)}`, summary: `${overlap.percentage}% overlap (${overlap.common}/${overlap.total} tasks)`, tasksByStatus: overlap.tasksByStatus };
                        }
                        html += `<td class="matrix-cell" style="background-color: ${color};" title="${tooltipText}" data-modal='${JSON.stringify(modalData).replace(/'/g, "&#39;")}'>
                            <div class="matrix-cell-content">
                                <div class="matrix-percentage">${overlap.percentage}%</div>
                                <div class="matrix-details">${overlap.common}/${overlap.total}</div>
                            </div>
                        </td>`;
                        return;
                    }
                    const dis = matrix[key].disagree;
                    const color = generateDisagreementColor(dis);
                    let tooltipText, modalData;
                    if (!dis.total) {
                        tooltipText = 'No comparable tasks (all skipped or none in common)';
                        modalData = { title: `${escapeHtml(runA.run)} ‚â† ${escapeHtml(runB.run)}`, summary: 'All tasks were skipped or none in common', tasksByStatus: {} };
                    } else {
                        tooltipText = `Disagreement: ${dis.percentage}% (${dis.common}/${dis.total})`;
                        modalData = { title: `${escapeHtml(runA.run)} ‚â† ${escapeHtml(runB.run)}`, summary: `${dis.percentage}% disagreement (${dis.common}/${dis.total} tasks)`, tasksByStatus: dis.tasksByStatus };
                    }
                    html += `<td class="matrix-cell" style="background-color: ${color};" title="${tooltipText}" data-modal='${JSON.stringify(modalData).replace(/'/g, "&#39;")}'>
                        <div class="matrix-cell-content">
                            <div class="matrix-percentage">${dis.percentage}%</div>
                            <div class="matrix-details">${dis.common}/${dis.total}</div>
                        </div>
                    </td>`;
                });
                
                html += '</tr>';
            });
            
            html += `</tbody></table></div></body></html>`;
            return html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.filter-sort-controls input, .filter-sort-controls select, #search-filter').forEach(input => {
                input.addEventListener('input', filterAndSortTable);
            });
             document.querySelectorAll('.filter-sort-controls select').forEach(select => {
                select.addEventListener('change', filterAndSortTable);
            });
            setupSortButtons();
            setupClickableFilters();
            
            // Setup comparison checkboxes
            document.querySelectorAll('.run-compare-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCompareButton);
            });
            
            // Setup select all functionality
            const selectAllCheckbox = document.getElementById('select-all-runs');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const runCheckboxes = document.querySelectorAll('.run-compare-checkbox');
                    runCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateCompareButton();
                });
                
                // Update select all checkbox when individual checkboxes change
                document.querySelectorAll('.run-compare-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const runCheckboxes = document.querySelectorAll('.run-compare-checkbox');
                        const checkedBoxes = document.querySelectorAll('.run-compare-checkbox:checked');
                        selectAllCheckbox.checked = runCheckboxes.length === checkedBoxes.length;
                        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < runCheckboxes.length;
                    });
                });
            }
            updateCompareButton();
            
            // Initialize counter once DOM is ready
            filterAndSortTable();
        });
    </script>
</head>
<body itemscope itemtype="https://schema.org/WebPage">
    <header>
        <h1 itemprop="headline">{{.VersionData.Name}} Run Results</h1>
    </header>
    <main itemprop="mainContentOfPage">
        <section aria-labelledby="runsummary" itemscope itemtype="https://schema.org/Table" itemprop="hasPart">
            <h2 id="runsummary" itemprop="headline">Summary</h2>
            <meta itemprop="alternativeHeadline" content="AI Model Evaluation Run Summary">
            <meta itemprop="description" content="Summary of passed, failed, error, and skipped counts, along with pass rate, accuracy, error rate, and total duration for each AI provider and run configuration. Pass Rate = Passed/(Passed+Failed+Error). Accuracy = Passed/(Passed+Failed). Error Rate = Error/(Passed+Failed+Error). Skipped tasks are excluded from rate calculations. Rates default to 0 when the denominator is 0.">
            <table id="summary-table">
                <caption class="visually-hidden">Run result summary by provider and run.</caption>
                <thead>
                    <tr>
                        <th scope="col" style="width: 30px; padding: 8px 4px; text-align: center; vertical-align: middle;">
                            <input type="checkbox" id="select-all-runs" title="Select/Deselect All Runs" style="margin: 0; vertical-align: middle;">
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Provider</span>
                                <span class="sort-btn" data-column="provider" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Run</span>
                                <span class="sort-btn" data-column="run" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Passed</span>
                                <span class="sort-btn" data-column="passed" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Failed</span>
                                <span class="sort-btn" data-column="failed" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Error</span>
                                <span class="sort-btn" data-column="error" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Skipped</span>
                                <span class="sort-btn" data-column="skipped" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Pass Rate (%)</span>
                                <span class="sort-btn" data-column="passrate" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Accuracy (%)</span>
                                <span class="sort-btn" data-column="accuracy" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Error Rate (%)</span>
                                <span class="sort-btn" data-column="errorrate" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="header-with-sort">
                                <span>Total Duration</span>
                                <span class="sort-btn" data-column="duration" data-direction="asc">‚ÜïÔ∏è</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {{- $results := .ResultsData -}}
                    {{- range $provider := SortResultsByProvider $results -}}
                    {{- $summary := $results.ProviderResultsByRunAndKind $provider -}}
                    {{- range $run := SortResultsByRunAndKind $summary -}}
                    {{- $group := index $summary $run }}
                    <tr itemscope itemtype="https://schema.org/Observation" data-provider="{{$provider}}" data-run="{{$run}}" data-passed="{{CountByKind $group 0}}" data-failed="{{CountByKind $group 1}}" data-error="{{CountByKind $group 2}}" data-skipped="{{CountByKind $group 3}}" data-passrate="{{printf "%.2f" (Percent (PassRate $group))}}" data-accuracy="{{printf "%.2f" (Percent (AccuracyRate $group))}}" data-errorrate="{{printf "%.2f" (Percent (ErrorRate $group))}}" data-duration="{{(TotalDuration $group 0 1 2 3).Milliseconds}}">
                        <td>
                            <input type="checkbox" class="run-compare-checkbox" data-provider="{{$provider}}" data-run="{{$run}}" title="Select for comparison">
                        </td>
                        <td itemprop="observationAbout" itemscope itemtype="https://schema.org/Organization" class="clickable-filter clickable" data-filter-type="provider" data-filter-value="{{$provider}}" title="Filter by provider: {{$provider}}">
                            <span itemprop="name">{{$provider}}</span>
                        </td>
                        <td itemprop="identifier" class="clickable-filter clickable" data-filter-type="run" data-filter-value="{{$run}}" title="Filter by run: {{$run}}">{{$run}}</td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Passed"><span itemprop="value">{{CountByKind $group 0}}</span></td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Failed"><span itemprop="value">{{CountByKind $group 1}}</span></td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Error"><span itemprop="value">{{CountByKind $group 2}}</span></td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Skipped"><span itemprop="value">{{CountByKind $group 3}}</span></td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Pass Rate (%)"><meta itemprop="unitText" content="%"><span itemprop="value">{{printf "%.2f" (Percent (PassRate $group))}}</span></td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Accuracy (%)"><meta itemprop="unitText" content="%"><span itemprop="value">{{printf "%.2f" (Percent (AccuracyRate $group))}}</span></td>
                        <td itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty"><meta itemprop="name" content="Error Rate (%)"><meta itemprop="unitText" content="%"><span itemprop="value">{{printf "%.2f" (Percent (ErrorRate $group))}}</span></td>
                        <td>
                            {{- $roundedTotal := (TotalDuration $group 0 1 2 3 | RoundToMS) -}}
                            <time itemprop="observationPeriod" datetime="PT{{printf "%.3f" ($roundedTotal.Seconds)}}S">{{$roundedTotal}}</time>
                        </td>
                    </tr>
                    {{- end -}}
                    {{- end -}}
                </tbody>
            </table>
            <div style="margin-top: 0;">
                <button id="compare-selected-btn" onclick="compareSelectedRuns()" disabled>Compare Selected Runs</button>
                <span id="selected-count" class="selected-count"></span>
            </div>
        </section>
        <section aria-labelledby="detailedresults" itemscope itemtype="https://schema.org/Table" itemprop="hasPart">
            <h2 id="detailedresults" itemprop="headline">Task Results</h2>
            <meta itemprop="alternativeHeadline" content="AI Model Evaluation Task Results">
            <meta itemprop="description" content="Detailed results for each task, including provider, run configuration, task name, status, duration, answer, and details.">
            <div class="filter-container">
                <input id="search-filter" type="text" placeholder="Search (regexp)..." title="Supports regular expressions, e.g. hello|world, ^start, end$, ^(?!visual\s*-\s*).*" class="filter-sort-controls">
                <button onclick="clearFilters()">Clear Filters</button>
                <div><span id="visible-count" aria-live="polite"></span> visible</div>
            </div>
            <table id="results-table">
                <caption class="visually-hidden">Detailed task evaluation results.</caption>
                <thead>
                    <tr>
                        <th>
                            <div class="filter-sort-controls">
                                <div class="header-with-sort">
                                    <span>Provider</span>
                                    <span class="sort-btn" data-column="provider" data-direction="asc">‚ÜïÔ∏è</span>
                                </div>
                                <select id="provider-filter">
                                    <option value="">All</option>
                                    {{- range SortResultsByProvider .ResultsData }}
                                    <option value="{{.}}">{{.}}</option>
                                    {{- end }}
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <div class="header-with-sort">
                                    <span>Run</span>
                                    <span class="sort-btn" data-column="run" data-direction="asc">‚ÜïÔ∏è</span>
                                </div>
                                <select id="run-filter">
                                    <option value="">All</option>
                                    {{- range UniqueRuns .ResultsData }}
                                    <option value="{{.}}">{{.}}</option>
                                    {{- end }}
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <div class="header-with-sort">
                                    <span>Task</span>
                                    <span class="sort-btn" data-column="task" data-direction="asc">‚ÜïÔ∏è</span>
                                </div>
                                <input id="task-filter" type="text" placeholder="Filter (regexp)..." title="Supports regular expressions, e.g. task-(one|two), ^task, ^(?!visual\s*-\s*).*">
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <div class="header-with-sort">
                                    <span>Status</span>
                                    <span class="sort-btn" data-column="status" data-direction="asc">‚ÜïÔ∏è</span>
                                </div>
                                <select id="status-filter">
                                    <option value="">All</option>
                                    <option value="passed">Passed</option>
                                    <option value="failed">Failed</option>
                                    <option value="error">Error</option>
                                    <option value="skipped">Skipped</option>
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <div class="header-with-sort">
                                    <span>Duration</span>
                                    <span class="sort-btn" data-column="duration" data-direction="asc">‚ÜïÔ∏è</span>
                                </div>
                            </div>
                        </th>
                        <th>Answer</th>
                        <th class="details-header">Details</th>
                    </tr>
                </thead>
                <tbody>
                    {{- $results := .ResultsData -}}
                    {{- range $provider := SortResultsByProvider $results -}}
                    {{- range $index, $result := index $results $provider }}
                    <tr id="{{$result.GetID}}" itemscope itemtype="https://schema.org/Question" data-provider="{{$provider}}" data-run="{{$result.Run}}" data-task="{{$result.Task}}" data-status="{{ToStatus $result.Kind | ToLower}}" data-duration="{{$result.Duration.Milliseconds}}">
                        <td itemprop="publisher" itemscope itemtype="https://schema.org/Organization" class="clickable-filter clickable" data-filter-type="provider" data-filter-value="{{$provider}}" title="Filter by provider: {{$provider}}"><span itemprop="name">{{$provider}}</span></td>
                        <td class="clickable-filter clickable" data-filter-type="run" data-filter-value="{{$result.Run}}" title="Filter by run: {{$result.Run}}"><span itemprop="identifier">{{$result.Run}}</span></td>
                        <td class="clickable-filter clickable" data-filter-type="task" data-filter-value="{{$result.Task}}" title="Filter by task: {{$result.Task}}"><span itemprop="name">{{$result.Task}}</span></td>
                        <td class="status-{{ToStatus $result.Kind | ToLower}} clickable-filter clickable" data-filter-type="status" data-filter-value="{{ToStatus $result.Kind | ToLower}}" title="Filter by status: {{ToStatus $result.Kind}}">
                            <span itemscope itemtype="https://schema.org/PropertyValue" itemprop="additionalProperty">
                                <meta itemprop="name" content="status">
                                <span itemprop="value">{{ToStatus $result.Kind}}</span>
                            </span>
                        </td>
                        <td>
                            {{- $roundedDur := (RoundToMS $result.Duration) -}}
                            <time itemprop="timeRequired" datetime="PT{{printf "%.3f" ($roundedDur.Seconds)}}S">{{$roundedDur}}</time>
                        </td>
                        <td class="details-cell">
                            {{- $answers := FormatAnswer $result true -}}
                            {{/* Display-only answer summary (may be diff or error text). No structured data here since the canonical suggestedAnswer is provided in the details section. */}}
                            <ol class="answer-list {{if eq (len $answers) 1}}single{{end}}">
                                {{- range $i, $ans := $answers }}
                                <li>{{SafeHTML .}}</li>
                                {{- end }}
                            </ol>
                        </td>
                        <td class="details-toggle-cell">
                            <button class="details" onclick="toggleDetails('details-{{$result.GetID}}', this)" aria-expanded="false" aria-controls="details-{{$result.GetID}}">Show Details</button>
                            <div id="details-{{$result.GetID}}" class="details-content">
                                {{- with $ad := $result.Details.Answer -}}
                                {{- if or $ad.Explanation $ad.ActualAnswer $ad.ExpectedAnswer }}
                                <section class="section-answer">
                                    <div itemscope itemtype="https://schema.org/Answer" itemprop="suggestedAnswer" {{with $vd := $result.Details.Validation}}{{if $vd.Explanation}}itemref="validation-{{$result.GetID}}"{{end}}{{end}}>
                                        {{if $ad.Title}}<h4 itemprop="name">{{$ad.Title}}</h4>{{else}}<h4 class="visually-hidden" itemprop="name">Suggested Answer</h4>{{end}}
                                        {{- if $ad.Explanation }}
                                        <details class="explanation" open itemprop="answerExplanation" itemscope itemtype="https://schema.org/Comment">
                                            <summary>Answer Explanation</summary>
                                            <div class="explanation-body" style="margin-top:0.5em;" itemprop="text">
                                                {{- range GroupParagraphs $ad.Explanation }}
                                                <p class="para">{{Join . " "}}</p>
                                                {{- end }}
                                            </div>
                                        </details>
                                        {{- end }}
                                        {{- if $ad.ActualAnswer }}
                                        <details open>
                                            <summary>Actual Answer</summary>
                                            <ol style="margin:0.5em 0 0 1.2em; list-style:none; padding:0;">
                                                <li style="margin:0;">
                                                    <pre><code itemprop="text">{{range $line := $ad.ActualAnswer}}{{ $line }}
{{end}}</code></pre>
                                                </li>
                                            </ol>
                                        </details>
                                        {{- end }}
                                    </div>
                                    {{- if $ad.ExpectedAnswer }}
                                    <details>
                                        <summary>Expected Acceptable Answer(s)</summary>
                                        <ol class="expected-answers" style="margin:0.5em 0 0 1.2em; padding:0;">
                                            {{- range $ad.ExpectedAnswer }}
                                            <li itemscope itemtype="https://schema.org/Answer" itemprop="acceptedAnswer"><pre><code itemprop="text">{{range $line := .}}{{ $line }}
{{end}}</code></pre></li>
                                            {{- end }}
                                        </ol>
                                    </details>
                                    {{- end }}
                                    {{- with $u := $ad.Usage }}
                                        {{- if or $u.InputTokens $u.OutputTokens }}
                                        <details>
                                            <summary>Token Usage</summary>
                                            <dl class="tech-details" style="margin-top:0.4em;">
                                                {{- with $u.InputTokens }}<dt>Input</dt><dd>{{.}}</dd>{{ end -}}
                                                {{- with $u.OutputTokens }}<dt>Output</dt><dd>{{.}}</dd>{{ end -}}
                                            </dl>
                                        </details>
                                        {{- end }}
                                    {{- end }}
                                    {{- with $toolUsage := $ad.ToolUsage }}
                                        {{- if $toolUsage }}
                                        <details>
                                            <summary>Tool Usage</summary>
                                            <dl class="tech-details" style="margin-top:0.4em;">
                                                {{- range $toolName, $usage := $toolUsage }}
                                                    <dt>{{$toolName}}</dt>
                                                    <dd>
                                                        {{- with $usage.CallCount }}{{.}} call(s){{ end -}}
                                                        {{- if and $usage.CallCount $usage.TotalDuration }} taking {{ end -}}
                                                        {{- with $usage.TotalDuration }}{{RoundToMS .}}{{ end -}}
                                                    </dd>
                                                {{- end }}
                                            </dl>
                                        </details>
                                        {{- end }}
                                    {{- end }}
                                </section>
                                {{- end -}}
                                {{- end -}}
                                {{- with $vd := $result.Details.Validation -}}
                                {{- if $vd.Explanation }}
                                <section id="validation-{{$result.GetID}}" class="section-validation" itemscope itemtype="https://schema.org/Comment" itemprop="comment">
                                    {{if $vd.Title}}<h4>{{$vd.Title}}</h4>{{end}}
                                    <details class="explanation" open>
                                        <summary>Validation Explanation</summary>
                                        <div class="explanation-body" style="margin-top:0.5em;" itemprop="text">
                                            {{- range GroupParagraphs $vd.Explanation }}
                                            <p class="para">{{Join . " "}}</p>
                                            {{- end }}
                                        </div>
                                    </details>
                                    {{- with $vu := $vd.Usage }}
                                        {{- if or $vu.InputTokens $vu.OutputTokens }}
                                        <details>
                                            <summary>Token Usage</summary>
                                            <dl class="tech-details" style="margin-top:0.4em;">
                                                {{- with $vu.InputTokens }}<dt>Input</dt><dd>{{.}}</dd>{{ end -}}
                                                {{- with $vu.OutputTokens }}<dt>Output</dt><dd>{{.}}</dd>{{ end -}}
                                            </dl>
                                        </details>
                                        {{- end }}
                                    {{- end }}
                                    {{- with $toolUsage := $vd.ToolUsage }}
                                        {{- if $toolUsage }}
                                        <details>
                                            <summary>Tool Usage</summary>
                                            <dl class="tech-details" style="margin-top:0.4em;">
                                                {{- range $toolName, $usage := $toolUsage }}
                                                    <dt>{{$toolName}}</dt>
                                                    <dd>
                                                        {{- with $usage.CallCount }}{{.}} call(s){{ end -}}
                                                        {{- if and $usage.CallCount $usage.TotalDuration }} taking {{ end -}}
                                                        {{- with $usage.TotalDuration }}{{RoundToMS .}}{{ end -}}
                                                    </dd>
                                                {{- end }}
                                            </dl>
                                        </details>
                                        {{- end }}
                                    {{- end }}
                                </section>
                                {{- end -}}
                                {{- end -}}
                                {{- with $ed := $result.Details.Error -}}
                                {{- if $ed.Message }}
                                <section class="section-error">
                                    {{if $ed.Title}}<h4>{{$ed.Title}}</h4>{{end}}
                                    <p class="para" style="margin:0 0 0.6em 0;">{{ $ed.Message }}</p>
                                    {{- if $ed.Details }}
                                    <details open>
                                        <summary>Technical Details</summary>
                                        <dl class="tech-details">
                                            {{- range $k, $v := $ed.Details }}
                                            <dt>{{$k}}</dt>
                                            <dd><pre><code>{{range $line := $v}}{{ $line }}
{{end}}</code></pre></dd>
                                            {{- end }}
                                        </dl>
                                    </details>
                                    {{- end }}
                                    {{- with $eu := $ed.Usage }}
                                        {{- if or $eu.InputTokens $eu.OutputTokens }}
                                        <details>
                                            <summary>Token Usage</summary>
                                            <dl class="tech-details" style="margin-top:0.4em;">
                                                {{- with $eu.InputTokens }}<dt>Input</dt><dd>{{.}}</dd>{{ end -}}
                                                {{- with $eu.OutputTokens }}<dt>Output</dt><dd>{{.}}</dd>{{ end -}}
                                            </dl>
                                        </details>
                                        {{- end }}
                                    {{- end }}
                                    {{- with $toolUsage := $ed.ToolUsage }}
                                        {{- if $toolUsage }}
                                        <details>
                                            <summary>Tool Usage</summary>
                                            <dl class="tech-details" style="margin-top:0.4em;">
                                                {{- range $toolName, $usage := $toolUsage }}
                                                    <dt>{{$toolName}}</dt>
                                                    <dd>
                                                        {{- with $usage.CallCount }}{{.}} call(s){{ end -}}
                                                        {{- if and $usage.CallCount $usage.TotalDuration }} taking {{ end -}}
                                                        {{- with $usage.TotalDuration }}{{RoundToMS .}}{{ end -}}
                                                    </dd>
                                                {{- end }}
                                            </dl>
                                        </details>
                                        {{- end }}
                                    {{- end }}
                                </section>
                                {{- end -}}
                                {{- end }}
                            </div>
                            <div class="details-icons">
                                <button class="icon-btn" onclick="copyTraceID('{{$result.TraceID}}', this)" title="Copy Trace ID: {{$result.TraceID}}" aria-label="Copy Trace ID">üìã</button>
                                {{- $allTools := SortToolsByName $result.Details.Answer.ToolUsage $result.Details.Validation.ToolUsage $result.Details.Error.ToolUsage -}}
                                {{- if $allTools }}
                                <span class="icon-btn" title="Tools used: {{Join $allTools ", "}}" aria-hidden="true">üîß</span>
                                {{- end }}
                            </div>
                        </td>
                    </tr>
                    {{- end -}}
                    {{- end -}}
                </tbody>
            </table>
        </section>
    </main>
    <footer>
          Generated by <span itemprop="creator" itemscope itemtype="https://schema.org/SoftwareApplication">
                <a href="https://{{.VersionData.Source}}" target="_blank" rel="noopener"
                    title="Visit {{.VersionData.Name}} source repository" itemprop="downloadUrl releaseNotes discussionUrl url"><span itemprop="name">{{.VersionData.Name}}</span></a>
                <span itemprop="softwareVersion">{{.VersionData.Version}}</span></span> on <span itemprop="dateCreated">{{Timestamp}}</span>.
    </footer>
</body>
</html>