<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MindTrial - Run Results</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --background-color: #f7f7f7;
            --text-color: #333;
            --header-color: #444;
            --table-bg: #fff;
            --table-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --row-hover-bg: #f1f9ff;
            --row-even-bg: #f2f2f2;
            --row-odd-bg: #ffffff;
            --success-bg: #d4edda;
            --success-text: #155724;
            --failure-bg: #fff3cd;
            --failure-text: #856404;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --skipped-bg: #e2e3e5;
            --skipped-text: #383d41;
            --border-color: #e0e0e0;
             
            --matrix-header-size: 120px;  
            --matrix-header-fudge: 4px;   
            --matrix-cell-size: 60px;    
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 1em;
        }
        h1, h2 {
            text-align: center;
            color: var(--header-color);
        }
        h1 { margin-bottom: 0.2em; }
        h2 { margin-top: 1.5em; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2em;
            box-shadow: var(--table-shadow);
            background-color: var(--table-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }
        thead th {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            position: relative;
        }
    thead th .filter-sort-controls span { white-space: nowrap; }
    thead th .filter-sort-controls span .sort-btn { margin-left:4px; }
     
    table:not(.matrix-table) tbody tr:nth-child(even) { background-color: var(--row-even-bg); }
    table:not(.matrix-table) tbody tr:nth-child(odd) { background-color: var(--row-odd-bg); }
    table:not(.matrix-table) tbody tr:hover { background-color: var(--row-hover-bg); }
        .status-passed { background-color: var(--success-bg); color: var(--success-text); font-weight: bold; }
        .status-failed { background-color: var(--failure-bg); color: var(--failure-text); font-weight: bold; }
        .status-error { background-color: var(--error-bg); color: var(--error-text); font-weight: bold; }
        .status-skipped { background-color: var(--skipped-bg); color: var(--skipped-text); font-weight: bold; }
    .details { cursor: pointer; color: var(--primary-color); font-weight: 600; text-decoration: underline; background: none; border: none; padding: 0; font-size: 0.95em; }
        .details:focus { outline: 2px solid var(--primary-color); }
    .details-content { display: none; background-color: #fafafa; border: 1px solid var(--border-color); margin-top: 8px; padding: 14px 16px; font-size: 0.95em; border-radius:6px; max-width:900px; }
    .details-content section { margin-top: 1.1em; }
    .details-content section:first-of-type { margin-top: 0; }
    .details-content h4 { margin: 0 0 0.35em 0; color: var(--header-color); font-size: 1.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
     
    .details-content summary { white-space: nowrap; cursor: pointer; }
    .details-content details { margin: 0.4em 0; }
      
     .details-content details summary { list-style:none; cursor:pointer; position:relative; padding-left:1.1em; }
     .details-content details summary::-webkit-details-marker { display:none; }
    .details-content details summary:before { content:'▶'; position:absolute; left:0; top:0.12em; font-size:0.92em; line-height:1; }
     .details-content details[open] summary:before { content:'▼'; }
      
     .details-content details.explanation { padding-left:1.1em; }
     .details-content details.explanation summary { padding-left:0; }
     .details-content details.explanation summary:before { left:-1.1em; }
     .details-content details.explanation .explanation-body { margin-left:0; }
     
    .details-content ol.expected-answers { margin-left:1.2em; }
    .details-content ol.expected-answers li::marker { font-weight:700; font-size:0.8em; color:#555; }
    .section-answer { border-left: 4px solid var(--primary-color); padding-left: 10px; }
    .section-validation { border-left: 4px solid #28a745; padding-left: 10px; }
    .section-error { border-left: 4px solid #c0392b; padding-left: 10px; background: #fff6f6; }
    .section-error h4 { color: #a1271c; }
    .details-content pre { background:#fff; border:1px solid var(--border-color); padding:6px 8px; overflow:auto; border-radius:4px; max-height:300px; white-space:pre-wrap; word-break:break-word; }
    .details-content code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 0.85em; }
    .details-content dl { margin:0.5em 0 0 0; }
    .details-content dt { font-weight:600; margin-top:0.6em; font-size:0.85em; }
     .details-content dd { margin:0.2em 0 0.6em 0.8em; font-size:0.85em; }
      
     .details-content dl.tech-details { padding-left:1.2em; }
     .details-content dl.tech-details dt { margin-left:-1.2em; }
     .details-content dl.tech-details dd { margin:0.2em 0 0.6em 0; }
     
    td.details-toggle-cell { min-width:130px; vertical-align: top; text-align:right; }
    td.details-toggle-cell .details { white-space:nowrap; }
    td.details-toggle-cell .details-content { margin-top:8px; text-align:left; }
    .answer-list { margin: 0; padding-left: 1.5em; }
        .answer-list li { margin-bottom: 1em; }
        .answer-list.single { list-style-type: none; padding-left: 0; }
        .answer-list.single li { margin-bottom: 0; }
        .filter-container { display: flex; gap: 10px; margin-bottom: 10px; max-width: 800px; align-items: center; }
        .filter-sort-controls { display: flex; flex-direction: column; gap: 5px; }
        .filter-sort-controls input, .filter-sort-controls select { width: 100%; box-sizing: border-box; }
        .sort-btn { cursor: pointer; margin-left: 5px; }
        .clickable { cursor: pointer; }
    footer { text-align: center; font-size: 0.85em; color: #777; margin-top: 2em; border-top: 1px solid var(--border-color); padding-top: 1em; }
    .para { margin:0 0 0.7em 0; }
    .para:last-child { margin-bottom:0; }
    .visually-hidden { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0; }
    th.details-header { text-align:right; min-width:130px; }
    
     
    .matrix-container { 
        padding: 20px;  
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        display: flex;
        flex-direction: column;
        align-items: center;
        width: calc(100% - 40px);  
        max-width: max-content;
        margin: 0 auto;
        box-sizing: border-box;
    }
    .matrix-table { 
        border-collapse: collapse; 
        border-spacing: 0; 
        margin: 10px auto; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        width: auto;  
        max-width: max-content;  
        table-layout: fixed;  
    }
    .matrix-table th, .matrix-table td { border: 1px solid #ddd; text-align: center; vertical-align: middle; box-sizing: border-box; }
    .matrix-table th { 
        background-color: var(--primary-color); 
        color: white; 
        font-weight: 600; 
        padding: 4px 2px; 
        font-size: 0.7em;
        text-transform: none;
        line-height: 1.1;
    }
    .matrix-table .matrix-header { 
        writing-mode: vertical-lr; 
        text-orientation: mixed; 
        min-width: 30px; 
        max-width: 40px;  
    width: 30px;
    height: calc(var(--matrix-header-size) + var(--matrix-header-fudge));
    max-height: 200px;  
        white-space: normal; 
        overflow: hidden; 
        overflow-wrap: break-word;
        word-break: break-word;
        padding: 4px 1px; 
        font-size: 0.65em;
        font-weight: 600;
        line-height: 1.0;
        text-transform: none;
    box-sizing: border-box;  
    }
    .matrix-table .matrix-row-header { 
        background-color: var(--primary-color); 
        color: white; 
        font-weight: 600; 
    padding: 4px 1px; 
        text-align: center; 
    width: var(--matrix-header-size);
    max-width: 200px;  
        white-space: normal; 
        overflow: hidden; 
        font-size: 0.65em;
        line-height: 1.0;
        word-break: break-all;
        text-transform: none;
    box-sizing: border-box;  
    }
    .matrix-cell { 
    width: var(--matrix-cell-size); 
    height: var(--matrix-cell-size); 
        padding: 2px; 
        position: relative; 
        cursor: default;
        transition: background-color 0.2s ease;
    box-sizing: border-box;
    }
     
    .matrix-cell.mirror-cell {
        background: transparent !important;
        cursor: default;
        pointer-events: none;
    }
    .matrix-cell.diagonal { font-weight: bold; }
    .matrix-cell-content { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; font-size: 0.8em; }
    .matrix-percentage { font-weight: bold; margin-bottom: 1px; font-size: 0.9em; }
    .matrix-details { font-size: 0.7em; opacity: 0.9; }
    .matrix-legend { 
        margin: 10px 0; 
        padding: 8px 12px; 
        background-color: #f8f9fa; 
        border-radius: 4px; 
        font-size: 0.85em;
        width: 100%;  
        box-sizing: border-box;  
    }
    .matrix-legend h3 { margin: 0 0 8px 0; color: var(--header-color); font-size: 1em; }
    .matrix-legend-items { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        margin-bottom: 5px; 
        justify-content: flex-start;  
    }
    .matrix-legend-item { display: flex; align-items: center; }
    .matrix-legend-color { display: inline-block; width: 16px; height: 12px; margin-right: 5px; border: 1px solid #ccc; }
    .matrix-legend p { margin: 5px 0 0 0; font-size: 0.8em; color: #666; }
     
    #summary-table { margin-bottom: 10px; }
    
    #compare-selected-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
    <script>
        function toggleDetails(id, btn) {
            const element = document.getElementById(id);
            const show = (element.style.display === "none" || element.style.display === "");
            element.style.display = show ? "block" : "none";
            if (btn) {
                btn.setAttribute('aria-expanded', show ? 'true' : 'false');
                btn.textContent = show ? 'Hide Details' : 'Show Details';
            }
        }

        function updateVisibleCount(table) {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const visible = rows.filter(r => r.style.display !== 'none').length;
            const counter = document.getElementById('visible-count');
            if (counter) counter.textContent = visible;
        }

        function filterAndSortTable() {
            const table = document.getElementById('results-table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const filters = {
                provider: document.getElementById('provider-filter').value.toLowerCase(),
                run: document.getElementById('run-filter').value.toLowerCase(),
                task: document.getElementById('task-filter').value,
                status: document.getElementById('status-filter').value.toLowerCase(),
                search: document.getElementById('search-filter').value
            };
            let taskRegex = null, searchRegex = null;
            if (filters.task) {
                try { taskRegex = new RegExp(filters.task, 'i'); } catch (e) { taskRegex = null; }
            }
            if (filters.search) {
                try { searchRegex = new RegExp(filters.search, 'i'); } catch (e) { searchRegex = null; }
            }
            rows.forEach(row => {
                const provider = row.dataset.provider.toLowerCase();
                const run = row.dataset.run.toLowerCase();
                const task = row.dataset.task;
                const status = row.dataset.status.toLowerCase();

                const searchMatch = searchRegex ? (searchRegex.test(provider) || searchRegex.test(run) || searchRegex.test(task)) : (!filters.search || provider.includes(filters.search.toLowerCase()) || run.includes(filters.search.toLowerCase()) || task.toLowerCase().includes(filters.search.toLowerCase()));

                const show = (filters.provider === '' || provider === filters.provider) &&
                             (filters.run === '' || run === filters.run) &&
                             (!taskRegex || taskRegex.test(task)) &&
                             (filters.status === '' || status === filters.status) &&
                             (filters.search === '' || searchMatch);
                
                row.style.display = show ? '' : 'none';
            });
            updateVisibleCount(table);
        }

        function sortTable(tableId, column, direction) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let valA, valB;
                if (column.startsWith('duration') || column.startsWith('passed') || column.startsWith('failed') || column.startsWith('error') || column.startsWith('skipped')) {
                    valA = parseFloat(a.dataset[column]);
                    valB = parseFloat(b.dataset[column]);
                } else {
                    valA = a.dataset[column].toLowerCase();
                    valB = b.dataset[column].toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function setupSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tableId = button.closest('table').id;
                    const column = button.dataset.column;
                    const direction = button.dataset.direction || 'asc';
                    
                    document.querySelectorAll(`#${tableId} .sort-btn`).forEach(btn => {
                        if (btn !== button) {
                            btn.innerHTML = '↕️';
                            delete btn.dataset.direction;
                        }
                    });

                    sortTable(tableId, column, direction);
                    button.innerHTML = direction === 'asc' ? '🔼' : '🔽';
                    button.dataset.direction = direction === 'asc' ? 'desc' : 'asc';
                });
            });
        }
        
        function setupClickableFilters() {
            document.querySelectorAll('.clickable-filter').forEach(element => {
                element.addEventListener('click', () => {
                    const filterType = element.dataset.filterType;
                    const filterValue = element.dataset.filterValue;
                    document.getElementById(`${filterType}-filter`).value = filterValue;
                    filterAndSortTable();
                });
            });
        }

        function clearFilters() {
            document.getElementById('provider-filter').value = '';
            document.getElementById('run-filter').value = '';
            document.getElementById('task-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('search-filter').value = '';
            filterAndSortTable();
        }

        function updateCompareButton() {
            const checkboxes = document.querySelectorAll('.run-compare-checkbox:checked');
            const button = document.getElementById('compare-selected-btn');
            const counter = document.getElementById('selected-count');
            
            button.disabled = checkboxes.length < 2;
            counter.textContent = checkboxes.length > 0 ? `${checkboxes.length} selected` : '';
        }

        function compareSelectedRuns() {
            const checkboxes = document.querySelectorAll('.run-compare-checkbox:checked');
            if (checkboxes.length < 2) return;

            const selectedRuns = Array.from(checkboxes).map(cb => ({
                provider: cb.dataset.provider,
                run: cb.dataset.run,
                key: `${cb.dataset.provider}-${cb.dataset.run}`
            }));

            const matrix = generateComparisonMatrix(selectedRuns);
            openMatrixWindow(matrix, selectedRuns);
        }

        function generateComparisonMatrix(runs) {
            const matrix = {};
            const results = getResultsData();

            for (let i = 0; i < runs.length; i++) {
                for (let j = 0; j < runs.length; j++) {
                    const runA = runs[i];
                    const runB = runs[j];
                    const key = `${runA.key}-${runB.key}`;
                    
                    if (i === j) {
                        
                        const data = results[runA.key] || {};
                        const tasks = Object.keys(data).filter(task => data[task] !== 'skipped');
                        const breakdown = {};
                        tasks.forEach(task => {
                            const status = data[task];
                            breakdown[status] = (breakdown[status] || 0) + 1;
                        });
                        matrix[key] = { 
                            percentage: 100, 
                            identical: true, 
                            breakdown: breakdown,
                            total: tasks.length,
                            common: tasks.length
                        };
                    } else {
                        matrix[key] = calculateOverlap(runA, runB, results);
                    }
                }
            }

            return matrix;
        }

        function getResultsData() {
            const results = {};
            const rows = document.querySelectorAll('#results-table tbody tr');
            
            rows.forEach(row => {
                const provider = row.dataset.provider;
                const run = row.dataset.run;
                const task = row.dataset.task;
                const status = row.dataset.status;
                
                const key = `${provider}-${run}`;
                if (!results[key]) results[key] = {};
                results[key][task] = status;
            });
            
            return results;
        }

        function calculateOverlap(runA, runB, results) {
            const dataA = results[runA.key] || {};
            const dataB = results[runB.key] || {};
            
            const commonTasks = Object.keys(dataA).filter(task => task in dataB);
            const nonSkippedTasks = commonTasks.filter(task => 
                dataA[task] !== 'skipped' && dataB[task] !== 'skipped'
            );
            
            if (nonSkippedTasks.length === 0) {
                return { percentage: 0, breakdown: {}, total: 0, common: 0 };
            }
            
            const matching = nonSkippedTasks.filter(task => dataA[task] === dataB[task]);
            const percentage = Math.round((matching.length / nonSkippedTasks.length) * 100);
            
            const breakdown = {};
            matching.forEach(task => {
                const status = dataA[task];
                breakdown[status] = (breakdown[status] || 0) + 1;
            });
            
            return {
                percentage,
                breakdown,
                total: nonSkippedTasks.length,
                common: matching.length
            };
        }

        function generateMatrixColor(overlap) {
            if (overlap.percentage === 0) return 'transparent';
            
            const saturation = overlap.percentage / 100;
            const total = overlap.common;
            
            if (total === 0) return 'transparent';
            
            const passed = overlap.breakdown.passed || 0;
            const failed = overlap.breakdown.failed || 0;
            const error = overlap.breakdown.error || 0;
            
            const passedRatio = passed / total;
            const failedRatio = failed / total;
            const errorRatio = error / total;
            
            const r = Math.round(155 * passedRatio + 255 * failedRatio + 255 * errorRatio);
            const g = Math.round(255 * passedRatio + 255 * failedRatio + 100 * errorRatio);
            const b = Math.round(155 * passedRatio + 100 * failedRatio + 100 * errorRatio);
            
            return `rgba(${r}, ${g}, ${b}, ${saturation})`;
        }

        function openMatrixWindow(matrix, runs) {
            const html = generateMatrixHTML(matrix, runs);
            
            const cellWidth = 60;      
            const headerWidth = 120;   
            const padding = 80;
            const titleHeight = 60;    
            const legendHeight = 120;  
            const headerRowHeight = 120; 
            const containerPadding = 30; 
            const tableMargins = 40;   
            const extraBuffer = 60;    
            const minWidth = 600; 
            const minHeight = 500;     
            
            
            const tableWidth = headerWidth + (runs.length * cellWidth) + padding + 50;
            const legendMinWidth = 450; 
            const calculatedWidth = Math.max(tableWidth, legendMinWidth);
            const matrixRowsHeight = Math.max(runs.length * 60, 180); 
            const tableHeight = titleHeight + legendHeight + headerRowHeight + containerPadding + 
                              tableMargins + matrixRowsHeight + extraBuffer;
            
            const width = Math.max(minWidth, Math.min(1400, calculatedWidth));
            const height = Math.max(minHeight, Math.min(1000, tableHeight));
            
            const newWindow = window.open('', '_blank', `width=${width},height=${height},scrollbars=yes,resizable=yes`);
            newWindow.document.write(html);
            newWindow.document.close();
        }

        function generateMatrixHTML(matrix, runs) {
            
            function escapeHtml(s) {
                return String(s).replace(/[&<>"']/g, c => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[c] || c);
            }
            let html = `
<!DOCTYPE html>
<html>
<head>
    <title>Run Comparison Matrix</title>
    <style>
        ${document.querySelector('style').textContent}
    </style>
    \x3Cscript>
        function setupMatrixHover() {
            const table = document.querySelector('.matrix-table');
            const cells = table.querySelectorAll('.matrix-cell');
            
            cells.forEach((cell, index) => {
                const row = Math.floor(index / ${runs.length});
                const col = index % ${runs.length};
                
                cell.addEventListener('mouseenter', () => {
                    // Highlight row
                    const rowCells = table.querySelectorAll(\`tbody tr:nth-child(\${row + 1}) .matrix-cell\`);
                    rowCells.forEach(c => c.classList.add('row-highlight'));
                    
                    // Highlight column
                    const colCells = table.querySelectorAll(\`tbody tr .matrix-cell:nth-child(\${col + 2})\`);
                    colCells.forEach(c => c.classList.add('col-highlight'));
                });
                
                cell.addEventListener('mouseleave', () => {
                    // Remove all highlights
                    cells.forEach(c => {
                        c.classList.remove('row-highlight', 'col-highlight');
                    });
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', setupMatrixHover);
        function equalizeMatrixHeaderSizes() {
            const rowHeaders = Array.from(document.querySelectorAll('.matrix-row-header'));
            if (rowHeaders.length === 0) return;
            
            // Calculate target width but apply reasonable limits
            const currentWidths = rowHeaders.map(h => h.getBoundingClientRect().width);
            const maxCurrentWidth = Math.max(...currentWidths);
            
            // Limit growth: don't exceed 200px or grow more than 50% beyond original
            const originalWidth = 120; // var(--matrix-header-size)
            const maxAllowedWidth = Math.min(200, originalWidth * 1.5);
            const targetWidth = Math.min(maxCurrentWidth, maxAllowedWidth);
            
            // Only adjust column header height if it makes sense (avoid excessive growth)
            const targetHeight = Math.min(targetWidth + 4, 200); // +4 for fudge, max 200px
            
            document.querySelectorAll('.matrix-header').forEach(h => {
                h.style.height = targetHeight + 'px';
                // Don't change width - keep column headers narrow
            });
        }
        document.addEventListener('DOMContentLoaded', equalizeMatrixHeaderSizes);
        window.addEventListener('resize', equalizeMatrixHeaderSizes);
    \x3C/script>
    <style>
        .matrix-cell.row-highlight {
            box-shadow: inset 0 0 0 2px rgba(74, 144, 226, 0.4) !important;
        }
        .matrix-cell.col-highlight {
            box-shadow: inset 0 0 0 2px rgba(74, 144, 226, 0.4) !important;
        }
        .matrix-cell.row-highlight.col-highlight {
            box-shadow: inset 0 0 0 3px rgba(74, 144, 226, 0.6) !important;
        }
    </style>
</head>
<body>
    <div class="matrix-container">
        <h1>Run Comparison Matrix</h1>
        <div class="matrix-legend">
            <h3>Legend</h3>
            <div class="matrix-legend-items">
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(155, 255, 155, 0.8);"></span>
                    <span>Passed</span>
                </div>
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(255, 255, 100, 0.8);"></span>
                    <span>Failed</span>
                </div>
                <div class="matrix-legend-item">
                    <span class="matrix-legend-color" style="background-color: rgba(255, 100, 100, 0.8);"></span>
                    <span>Error</span>
                </div>
            </div>
            <p>Color saturation = overlap %, Color hue = distribution of overlapping results</p>
            <p>Only the lower triangle is shown (matrix is symmetric). The diagonal shows per-run result distribution.</p>
        </div>
        <table class="matrix-table">
            <thead>
                <tr>
                    <th></th>`;
            
            runs.forEach(run => {
                html += `<th class="matrix-header" title="${escapeHtml(run.provider)} - ${escapeHtml(run.run)}">${escapeHtml(run.run)}</th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            runs.forEach((runA, i) => {
                html += `<tr><th class="matrix-row-header" title="${escapeHtml(runA.provider)} - ${escapeHtml(runA.run)}">${escapeHtml(runA.run)}</th>`;
                
                runs.forEach((runB, j) => {
                    
                    if (j > i) {
                        html += `<td class="matrix-cell mirror-cell" aria-hidden="true"></td>`;
                        return;
                    }
                    const key = `${runA.key}-${runB.key}`;
                    const overlap = matrix[key];
                    const color = generateMatrixColor(overlap);
                    const isIdentical = i === j;
                    const p = overlap.breakdown.passed || 0;
                    const f = overlap.breakdown.failed || 0;
                    const e = overlap.breakdown.error || 0;
                    let titleText = '';
                    if (isIdentical) {
                        
                        titleText = `Run distribution: Passed ${p}, Failed ${f}, Error ${e}`;
                    } else if (!overlap.total) {
                        titleText = 'No comparable tasks (all skipped or none in common)';
                    } else {
                        titleText = `Overlap: ${overlap.percentage}% (${overlap.common}/${overlap.total}) | Passed ${p}, Failed ${f}, Error ${e}`;
                    }

                    html += `<td class="matrix-cell ${isIdentical ? 'diagonal' : ''}" 
                             style="background-color: ${color};" 
                             title="${titleText}">
                        <div class="matrix-cell-content">
                            <div class="matrix-percentage">${overlap.percentage}%</div>
                            <div class="matrix-details">${isIdentical ? overlap.total + ' tasks' : overlap.common + '/' + overlap.total}</div>
                        </div>
                    </td>`;
                });
                
                html += '</tr>';
            });
            
            html += `</tbody></table></div></body></html>`;
            return html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.filter-sort-controls input, .filter-sort-controls select, #search-filter').forEach(input => {
                input.addEventListener('input', filterAndSortTable);
            });
             document.querySelectorAll('.filter-sort-controls select').forEach(select => {
                select.addEventListener('change', filterAndSortTable);
            });
            setupSortButtons();
            setupClickableFilters();
            
            
            document.querySelectorAll('.run-compare-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCompareButton);
            });
            
            
            const selectAllCheckbox = document.getElementById('select-all-runs');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const runCheckboxes = document.querySelectorAll('.run-compare-checkbox');
                    runCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateCompareButton();
                });
                
                
                document.querySelectorAll('.run-compare-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const runCheckboxes = document.querySelectorAll('.run-compare-checkbox');
                        const checkedBoxes = document.querySelectorAll('.run-compare-checkbox:checked');
                        selectAllCheckbox.checked = runCheckboxes.length === checkedBoxes.length;
                        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < runCheckboxes.length;
                    });
                });
            }
            updateCompareButton();
            
            
            filterAndSortTable();
        });
    </script>
</head>
<body itemscope itemtype="https://schema.org/WebPage">
    <header>
        <h1 itemprop="headline">MindTrial Run Results</h1>
    </header>
    <main itemprop="mainContentOfPage">
        <section aria-labelledby="runsummary" itemscope itemtype="https://schema.org/Table" itemprop="hasPart">
            <h2 id="runsummary" itemprop="headline">Summary</h2>
            <meta itemprop="alternativeHeadline" content="AI Model Evaluation Run Summary">
            <meta itemprop="description" content="Summary of success, failure, error, and skipped counts, along with total duration for each AI provider and run configuration.">
            <table id="summary-table">
                <caption class="visually-hidden">Run result summary by provider and run.</caption>
                <thead>
                    <tr>
                        <th scope="col" style="width: 30px; padding: 8px 4px; text-align: center; vertical-align: middle;">
                            <input type="checkbox" id="select-all-runs" title="Select/Deselect All Runs" style="margin: 0; vertical-align: middle;">
                        </th>
                        <th scope="col">Provider <span class="sort-btn" data-column="provider" data-direction="asc">↕️</span></th>
                        <th scope="col">Run <span class="sort-btn" data-column="run" data-direction="asc">↕️</span></th>
                        <th scope="col">Passed <span class="sort-btn" data-column="passed" data-direction="asc">↕️</span></th>
                        <th scope="col">Failed <span class="sort-btn" data-column="failed" data-direction="asc">↕️</span></th>
                        <th scope="col">Error <span class="sort-btn" data-column="error" data-direction="asc">↕️</span></th>
                        <th scope="col">Skipped <span class="sort-btn" data-column="skipped" data-direction="asc">↕️</span></th>
                        <th scope="col">Total Duration <span class="sort-btn" data-column="duration" data-direction="asc">↕️</span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div style="margin-top: 0;">
                <button id="compare-selected-btn" onclick="compareSelectedRuns()" disabled>Compare Selected Runs</button>
                <span id="selected-count" style="margin-left: 10px; font-size: 0.9em; color: #666;"></span>
            </div>
        </section>
        <section aria-labelledby="detailedresults" itemscope itemtype="https://schema.org/Table" itemprop="hasPart">
            <h2 id="detailedresults" itemprop="headline">Task Results</h2>
            <meta itemprop="alternativeHeadline" content="AI Model Evaluation Task Results">
            <meta itemprop="description" content="Detailed results for each task, including provider, run configuration, task name, status, duration, answer, and details.">
            <div class="filter-container">
                <input id="search-filter" type="text" placeholder="Search (regexp)..." title="Supports regular expressions, e.g. hello|world, ^start, end$, ^(?!visual\s*-\s*).*" class="filter-sort-controls">
                <button onclick="clearFilters()">Clear Filters</button>
                <div><span id="visible-count" aria-live="polite"></span> visible</div>
            </div>
            <table id="results-table">
                <caption class="visually-hidden">Detailed task evaluation results.</caption>
                <thead>
                    <tr>
                        <th>
                            <div class="filter-sort-controls">
                                <span>Provider <span class="sort-btn" data-column="provider" data-direction="asc">↕️</span></span>
                                <select id="provider-filter">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <span>Run <span class="sort-btn" data-column="run" data-direction="asc">↕️</span></span>
                                <select id="run-filter">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <span>Task <span class="sort-btn" data-column="task" data-direction="asc">↕️</span></span>
                                <input id="task-filter" type="text" placeholder="Filter (regexp)..." title="Supports regular expressions, e.g. task-(one|two), ^task, ^(?!visual\s*-\s*).*">
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <span>Status <span class="sort-btn" data-column="status" data-direction="asc">↕️</span></span>
                                <select id="status-filter">
                                    <option value="">All</option>
                                    <option value="passed">Passed</option>
                                    <option value="failed">Failed</option>
                                    <option value="error">Error</option>
                                    <option value="skipped">Skipped</option>
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-sort-controls">
                                <span>Duration <span class="sort-btn" data-column="duration" data-direction="asc">↕️</span></span>
                            </div>
                        </th>
                        <th>Answer</th>
                        <th class="details-header">Details</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
    <footer>
          Generated by <span itemprop="creator" itemscope itemtype="https://schema.org/SoftwareApplication">
                <a href="https://github.com/petmal/mindtrial" target="_blank" rel="noopener"
                    title="Visit MindTrial source repository" itemprop="downloadUrl releaseNotes discussionUrl url"><span itemprop="name">MindTrial</span></a>
                <span itemprop="softwareVersion">(testing)</span></span> on <span itemprop="dateCreated">1985-03-04T22:10:00</span>.
    </footer>
</body>
</html>